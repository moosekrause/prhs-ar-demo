<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>PRHS ‚Ä¢ AR Tour</title>

<!-- A-Frame + AR.js (camera feed); no markers used -->
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>

<style>
  html,body{margin:0;height:100%;background:#0f2446;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  /* Overlays */
  .topbar{position:fixed;left:12px;right:12px;top:10px;display:flex;align-items:center;gap:10px;z-index:5}
  .brand{margin-right:auto;display:flex;align-items:center;gap:8px;color:#fff;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.5)}
  .brand small{font-weight:600;opacity:.9}
  .btn{background:#fff;border:none;border-radius:999px;padding:9px 14px;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.18);cursor:pointer}
  .donate img{width:110px;height:auto;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.28)}
  .donate{position:fixed;right:12px;top:56px;z-index:5}
  .panel{position:fixed;left:12px;right:12px;bottom:12px;z-index:5;
         background:rgba(255,255,255,.92);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.25);padding:10px 12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .panel label{font-size:12px;font-weight:700;margin-right:4px}
  input[type=range]{width:160px}
  .hint{position:fixed;left:0;right:0;top:34px;text-align:center;color:#fff;z-index:4;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,.5)}
  /* Start gate */
  .gate{position:fixed;inset:0;background:radial-gradient(120% 120% at 50% 40%,#1b3a7a 0%,#0f2446 60%,#0b1630 100%);
        display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:#fff;z-index:10;text-align:center;padding:24px}
  .gate h1{margin:0;font-size:22px}
  .gate p{margin:0;opacity:.9}
  .gate button{background:#fff;color:#0f2446;border:none;padding:12px 18px;border-radius:999px;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  /* Video element hidden (used as texture) */
  video{display:none}
</style>
</head>
<body>

<!-- Top: brand + About + Flip Camera -->
<div class="topbar">
  <div class="brand">PRHS ‚Ä¢ <small id="siteName">AR Tour</small></div>
  <button class="btn" id="aboutBtn">About Sponsor</button>
  <button class="btn" id="flipBtn">Flip Camera</button>
</div>

<!-- Donate graphic -->
<div class="donate">
  <a id="donateLink" href="#" target="_blank" rel="noopener">
    <img src="assets/Donate Walking Tour.png" alt="Donate to PRHS">
  </a>
</div>

<!-- Vantage hint -->
<div class="hint" id="vantageHint">Align the photo using drag/pinch/rotate until windows and rooflines match.</div>

<!-- Controls: opacity + nudge + reset + audio -->
<div class="panel">
  <label>Opacity</label>
  <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.8"/>
  <button class="btn" id="resetBtn">Reset</button>
  <button class="btn" id="unmuteBtn">üîá Unmute</button>
  <span style="font-size:12px;opacity:.7">Drag to move ‚Ä¢ Pinch to scale ‚Ä¢ Twist to rotate</span>
</div>

<!-- Start gate -->
<div class="gate" id="gate">
  <h1 id="gateTitle">AR Site</h1>
  <p id="gateDesc">Tap Start, allow camera access, then align the historic photo.</p>
  <button id="startBtn">Start</button>
</div>

<!-- Media sources -->
<video id="sponsorVid" autoplay muted playsinline loop></video>
<audio id="bgMusic" loop preload="auto"></audio>

<!-- Scene (markerless; content 2m in front) -->
<a-scene
  embedded
  vr-mode-ui="enabled:false"
  renderer="antialias:true; alpha:true"
  arjs="sourceType: webcam; facingMode: environment; trackingMethod: best; debugUIEnabled:false;">

  <a-entity light="type: ambient; intensity: 1"></a-entity>

  <!-- Group we manipulate via gestures -->
  <a-entity id="group" position="0 0 -2" rotation="0 0 0" scale="1 1 1">
    <!-- Historic photo overlay (gesture target) -->
    <a-plane id="historic"
      width="1.6" height="1.2"
      position="0 0.4 0"
      material="src: #histTex; transparent: true; opacity: 0.8; side: double;">
    </a-plane>

    <!-- Sponsor avatar video (optional chroma key) -->
    <a-video id="avatar"
      src="#sponsorVid"
      position="0 -0.05 0.01"
      width="1.2" height="0.68"
      autoplay="true" loop="true" muted="true" webkit-playsinline playsinline>
    </a-video>

    <!-- Label -->
    <a-plane position="0 -0.45 0" width="2.1" height="0.26" color="#ffffff" opacity="0.92">
      <a-entity id="labelText"
        text="value: Park Ridge Historical Society; color:#0f2446; align:center; width: 3.6;"
        position="0 0 0.01"></a-entity>
    </a-plane>
  </a-entity>

  <!-- Camera -->
  <a-entity camera></a-entity>
</a-scene>

<!-- Hidden image asset for the historic photo -->
<img id="histTex" src="" alt="" style="display:none"/>

<script>
/* ---------- Site config via ?site= param ---------- */
const SITES = {
  solomon: {
    name: "Solomon Cottage",
    histImg: "assets/Solomon-Cottage_-Very-Early-Image-300x230.jpg",
    sponsorVideo: "assets/Solomon Cottage.mp4",
    sponsorAboutUrl: "https://parkridgehistorycenter.org/",  // change as needed
    donateUrl: "#",                                         // replace with PRHS donate
    vantageHint: "Align roofline & porch columns with the live view, then adjust opacity.",
    label: "Park Ridge Historical Society ‚Ä¢ Solomon Cottage",
    bgMusic: "" // optional: e.g., "assets/background.mp3"
  },
  // Example second site (fill later)
  pickwick: {
    name: "Pickwick Theatre",
    histImg: "assets/pickwick.jpg",
    sponsorVideo: "assets/pickwick_sponsor.webm", // ideally WebM with alpha for true transparency
    sponsorAboutUrl: "https://example.com/pickwick",
    donateUrl: "#",
    vantageHint: "Match the marquee line to the current facade; use pinch/drag/rotate.",
    label: "PRHS ‚Ä¢ Pickwick Theatre",
    bgMusic: ""
  }
};

function getParam(name) {
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

const siteKey = (getParam("site") || "solomon").toLowerCase();
const site = SITES[siteKey] || SITES.solomon;

/* ---------- Wire UI to site config ---------- */
document.getElementById("siteName").textContent = site.name;
document.getElementById("gateTitle").textContent = site.name + " AR";
document.getElementById("vantageHint").textContent = site.vantageHint;
document.getElementById("labelText").setAttribute("text", "value", site.label);
document.getElementById("donateLink").href = site.donateUrl;

document.getElementById("histTex").src = site.histImg;
const sponsorVid = document.getElementById("sponsorVid");
sponsorVid.src = site.sponsorVideo;
const bgMusic = document.getElementById("bgMusic");
if (site.bgMusic) bgMusic.src = site.bgMusic;

/* ---------- Start gate / autoplay handling ---------- */
const gate = document.getElementById("gate");
document.getElementById("startBtn").addEventListener("click", async () => {
  try { await sponsorVid.play().catch(()=>{}); } catch(e){}
  if (bgMusic && site.bgMusic) { try { await bgMusic.play().catch(()=>{}); } catch(e){} }
  gate.style.display = "none";
});

/* ---------- Unmute toggle ---------- */
const unmuteBtn = document.getElementById("unmuteBtn");
let isMuted = true;
unmuteBtn.addEventListener("click", () => {
  isMuted = !isMuted;
  sponsorVid.muted = isMuted;
  unmuteBtn.textContent = isMuted ? "üîá Unmute" : "üîä Mute";
  if (!isMuted && bgMusic && site.bgMusic) { bgMusic.volume = 0.5; bgMusic.play().catch(()=>{}); }
  if (isMuted && bgMusic) { try{ bgMusic.pause(); }catch(e){} }
});

/* ---------- About Sponsor ---------- */
document.getElementById("aboutBtn").addEventListener("click", () => {
  if (site.sponsorAboutUrl && site.sponsorAboutUrl !== "#") {
    window.open(site.sponsorAboutUrl, "_blank", "noopener");
  } else {
    alert("Sponsor info coming soon.");
  }
});

/* ---------- Flip Camera (if supported) ---------- */
document.getElementById("flipBtn").addEventListener("click", () => {
  try {
    const sceneEl = document.querySelector('a-scene');
    const arjsSystem = sceneEl.systems && sceneEl.systems['arjs'];
    const src = arjsSystem && arjsSystem.arToolkitSource;
    if (src && typeof src.switchCamera === 'function') { src.switchCamera(); }
    else { alert('Flip camera not supported on this device/browser.'); }
  } catch(e) { console.warn(e); alert('Unable to switch camera.'); }
});

/* ---------- Opacity slider ---------- */
const opacity = document.getElementById("opacity");
const historic = document.getElementById("historic");
opacity.addEventListener("input", () => {
  historic.setAttribute("material", "opacity", parseFloat(opacity.value));
});

/* ---------- Reset ---------- */
const group = document.getElementById("group");
document.getElementById("resetBtn").addEventListener("click", () => {
  group.setAttribute("position", {x:0,y:0,z:-2});
  group.setAttribute("rotation", {x:0,y:0,z:0});
  group.setAttribute("scale", {x:1,y:1,z:1});
  opacity.value = 0.8;
  historic.setAttribute("material","opacity",0.8);
});

/* ---------- Gesture controls (drag / pinch / rotate) ----------
   Simple, robust mapping:
   - 1 finger drag: move X/Y in meters mapped from pixels
   - 2 finger pinch: scale
   - 2 finger twist: rotate Z
*/
let touches = [];
let base = {pos:{x:0,y:0}, scale:1, rotZ:0};
let start = {x:0,y:0, d:0, a:0};

function setFromGroup() {
  const p = group.getAttribute('position');
  const s = group.getAttribute('scale');
  const r = group.getAttribute('rotation');
  base.pos = {x:p.x, y:p.y};
  base.scale = s.x;
  base.rotZ = r.z;
}
setFromGroup();

function distance(t0,t1){ const dx=t1.clientX-t0.clientX, dy=t1.clientY-t0.clientY; return Math.hypot(dx,dy); }
function angle(t0,t1){ return Math.atan2(t1.clientY-t0.clientY, t1.clientX-t0.clientX); }

const mapPX = 0.0022; // meters per screen px for movement (tweak to taste)

function onTouchStart(e){
  e.preventDefault();
  touches = Array.from(e.touches);
  setFromGroup();
  if (touches.length===1){
    start.x = touches[0].clientX;
    start.y = touches[0].clientY;
  } else if (touches.length>=2){
    start.d = distance(touches[0], touches[1]);
    start.a = angle(touches[0], touches[1]);
  }
}
function onTouchMove(e){
  e.preventDefault();
  const ts = Array.from(e.touches);
  if (ts.length===1){
    const dx = (ts[0].clientX - start.x) * mapPX;
    const dy = (ts[0].clientY - start.y) * mapPX;
    group.setAttribute('position', {x: base.pos.x + dx, y: base.pos.y - dy, z: -2});
  } else if (ts.length>=2){
    const d = distance(ts[0], ts[1]);
    const a = angle(ts[0], ts[1]);
    const scale = Math.max(0.2, Math.min(6, base.scale * (d / Math.max(1,start.d))));
    const rotZ = base.rotZ + (a - start.a) * (180/Math.PI);
    group.setAttribute('scale', {x: scale, y: scale, z: scale});
    group.setAttribute('rotation', {x:0, y:0, z: rotZ});
  }
}
function onTouchEnd(e){
  e.preventDefault();
  if (e.touches.length===0){ setFromGroup(); }
}

window.addEventListener('touchstart', onTouchStart, {passive:false});
window.addEventListener('touchmove', onTouchMove, {passive:false});
window.addEventListener('touchend', onTouchEnd, {passive:false});
window.addEventListener('touchcancel', onTouchEnd, {passive:false});

/* ---------- Optional chroma key for transparent avatar ----------
   If you upload a green-screen WebM with alpha, you can skip this.
   If you only have green-screen MP4, you can approximate transparency
   by tinting out green via material shader. (Basic example below.)
*/
// Minimal ‚Äúfake‚Äù chroma: reduce green channel on the <a-video> by CSS filter.
// (True per-pixel key needs a WebGL shader and a green-screen source.)
document.getElementById('avatar').setAttribute('material', 'shader', 'flat');
</script>
</body>
</html>
