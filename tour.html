<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>PRHS â€¢ AR Tour</title>

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>

<style>
  html,body{margin:0;height:100%;background:#0f2446;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .topbar{position:fixed;left:12px;right:12px;top:10px;display:flex;align-items:center;gap:10px;z-index:5}
  .brand{margin-right:auto;display:flex;align-items:center;gap:8px;color:#fff;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.5)}
  .btn{background:#fff;border:none;border-radius:999px;padding:9px 14px;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.18);cursor:pointer}
  .donate{position:fixed;right:12px;top:56px;z-index:5}
  .donate img{width:110px;height:auto;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.28)}
  .panel{position:fixed;left:12px;right:12px;bottom:12px;z-index:5;background:rgba(255,255,255,.92);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.25);padding:10px 12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .panel label{font-size:12px;font-weight:700;margin-right:4px}
  input[type=range]{width:160px}
  .hint{position:fixed;left:0;right:0;top:34px;text-align:center;color:#fff;z-index:4;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,.5)}
  /* Start gate MUST sit above everything and accept taps */
  .gate{position:fixed;inset:0;background:radial-gradient(120% 120% at 50% 40%,#1b3a7a 0%,#0f2446 60%,#0b1630 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:#fff;z-index:9999;text-align:center;padding:24px;pointer-events:auto}
  .gate h1{margin:0;font-size:22px}
  .gate p{margin:0;opacity:.9}
  .gate button{background:#fff;color:#0f2446;border:none;padding:12px 18px;border-radius:999px;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  /* Until Start is pressed, DO NOT allow the scene/canvas to eat touches */
  #scene{pointer-events:none}
  /* Some mobile builds add .a-canvas; belt-and-suspenders: block it too until Start */
  .block-canvas-pointer .a-canvas, .block-canvas-pointer canvas.a-canvas{pointer-events:none !important}
  video{display:none}
</style>
</head>
<body class="block-canvas-pointer">

<!-- UI -->
<div class="topbar">
  <div class="brand">PRHS â€¢ <small id="siteName" style="font-weight:600;opacity:.9">AR Tour</small></div>
  <button class="btn" id="aboutBtn">About Sponsor</button>
  <button class="btn" id="flipBtn">Flip Camera</button>
</div>

<div class="donate">
  <a id="donateLink" href="#" target="_blank" rel="noopener">
    <img src="assets/Donate Walking Tour.png" alt="Donate to PRHS">
  </a>
</div>

<div class="hint" id="vantageHint">Align the photo using drag/pinch/rotate, then adjust opacity.</div>

<div class="panel">
  <label>Opacity</label>
  <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.8"/>
  <button class="btn" id="resetBtn">Reset</button>
  <button class="btn" id="unmuteBtn">ðŸ”‡ Unmute</button>
  <span style="font-size:12px;opacity:.7">Drag to move â€¢ Pinch to scale â€¢ Twist to rotate</span>
</div>

<!-- Start gate (on top; gets the tap) -->
<div class="gate" id="gate">
  <h1 id="gateTitle">AR Site</h1>
  <p id="gateDesc">Tap Start, allow camera access, then align the historic photo.</p>
  <button id="startBtn">Start</button>
</div>

<!-- Media -->
<video id="sponsorVid" autoplay muted playsinline loop></video>
<audio id="bgMusic" loop preload="auto"></audio>

<!-- Scene (blocked from pointer-events until Start) -->
<a-scene id="scene"
  embedded
  vr-mode-ui="enabled:false"
  renderer="antialias:true; alpha:true"
  arjs="sourceType: webcam; facingMode: environment; trackingMethod: best; debugUIEnabled:false;">

  <a-entity light="type: ambient; intensity: 1"></a-entity>

  <a-entity id="group" position="0 0 -2" rotation="0 0 0" scale="1 1 1">
    <a-plane id="historic" width="1.6" height="1.2" position="0 0.4 0"
      material="src: #histTex; transparent: true; opacity: 0.8; side: double;"></a-plane>

    <a-video id="avatar" src="#sponsorVid" position="0 -0.05 0.01" width="1.2" height="0.68"
      autoplay="true" loop="true" muted="true" webkit-playsinline playsinline></a-video>

    <a-plane position="0 -0.45 0" width="2.1" height="0.26" color="#ffffff" opacity="0.92">
      <a-entity id="labelText" text="value: Park Ridge Historical Society; color:#0f2446; align:center; width: 3.6;"
        position="0 0 0.01"></a-entity>
    </a-plane>
  </a-entity>

  <a-entity camera></a-entity>
</a-scene>

<img id="histTex" src="" alt="" style="display:none"/>

<script>
/* ---- Config via ?site= ---- */
const SITES = {
  solomon: {
    name: "Solomon Cottage",
    histImg: "assets/Solomon-Cottage_-Very-Early-Image-300x230.jpg",
    sponsorVideo: "assets/Solomon Cottage.mp4",
    sponsorAboutUrl: "https://parkridgehistorycenter.org/",
    donateUrl: "#",
    vantageHint: "Match porch posts & roofline; fine-tune with opacity.",
    label: "Park Ridge Historical Society â€¢ Solomon Cottage",
    bgMusic: ""
  }
};
function getParam(n){return new URL(location.href).searchParams.get(n)}
const siteKey=(getParam("site")||"solomon").toLowerCase();
const site=SITES[siteKey]||SITES.solomon;

/* ---- Bind UI ---- */
document.getElementById("siteName").textContent = site.name;
document.getElementById("gateTitle").textContent = site.name + " AR";
document.getElementById("vantageHint").textContent = site.vantageHint;
document.getElementById("labelText").setAttribute("text","value",site.label);
document.getElementById("donateLink").href = site.donateUrl;
document.getElementById("histTex").src = site.histImg;

const sponsorVid = document.getElementById("sponsorVid"); sponsorVid.src = site.sponsorVideo;
const bgMusic = document.getElementById("bgMusic"); if(site.bgMusic) bgMusic.src = site.bgMusic;

/* ---- Start gate: enable camera & interactions ---- */
const gate = document.getElementById("gate");
document.getElementById("startBtn").addEventListener("click", async () => {
  try { await sponsorVid.play().catch(()=>{}); } catch(e){}
  if (site.bgMusic){ try{ await bgMusic.play().catch(()=>{});}catch(e){} }
  gate.style.display = "none";
  // Now let the scene receive touches
  document.getElementById('scene').style.pointerEvents = 'auto';
  document.body.classList.remove('block-canvas-pointer');
});

/* ---- Un/mute ---- */
const unmuteBtn=document.getElementById("unmuteBtn"); let isMuted=true;
unmuteBtn.addEventListener("click",()=>{
  isMuted=!isMuted; sponsorVid.muted=isMuted;
  unmuteBtn.textContent=isMuted?"ðŸ”‡ Unmute":"ðŸ”Š Mute";
  if(!isMuted && site.bgMusic){ bgMusic.volume=0.5; bgMusic.play().catch(()=>{});} else { try{bgMusic.pause();}catch(e){} }
});

/* ---- About & Flip ---- */
document.getElementById("aboutBtn").addEventListener("click",()=>{
  if(site.sponsorAboutUrl && site.sponsorAboutUrl!=="#") window.open(site.sponsorAboutUrl,"_blank","noopener");
});
document.getElementById("flipBtn").addEventListener("click",()=>{
  try{
    const sceneEl=document.querySelector('a-scene');
    const arjsSystem=sceneEl.systems && sceneEl.systems['arjs'];
    const src=arjsSystem && arjsSystem.arToolkitSource;
    if(src && typeof src.switchCamera==='function'){ src.switchCamera(); }
    else{ alert('Flip camera not supported on this device/browser.'); }
  }catch(e){ alert('Unable to switch camera.'); }
});

/* ---- Opacity + Reset ---- */
const opacity=document.getElementById("opacity"), historic=document.getElementById("historic");
opacity.addEventListener("input",()=> historic.setAttribute("material","opacity",parseFloat(opacity.value)));
const group=document.getElementById("group");
document.getElementById("resetBtn").addEventListener("click",()=>{
  group.setAttribute("position",{x:0,y:0,z:-2});
  group.setAttribute("rotation",{x:0,y:0,z:0});
  group.setAttribute("scale",{x:1,y:1,z:1});
  opacity.value=0.8; historic.setAttribute("material","opacity",0.8);
});

/* ---- Gestures ---- */
let base={pos:{x:0,y:0},scale:1,rotZ:0}, start={x:0,y:0,d:0,a:0};
function setFromGroup(){ const p=group.getAttribute('position'), s=group.getAttribute('scale'), r=group.getAttribute('rotation'); base.pos={x:p.x,y:p.y}; base.scale=s.x; base.rotZ=r.z; }
setFromGroup();
function dist(t0,t1){const dx=t1.clientX-t0.clientX,dy=t1.clientY-t0.clientY;return Math.hypot(dx,dy)}
function ang(t0,t1){return Math.atan2(t1.clientY-t0.clientY,t1.clientX-t0.clientX)}
const mapPX=0.0022;
function ts(e){return Array.from(e.touches)}
addEventListener('touchstart',e=>{e.preventDefault();const t=ts(e);setFromGroup(); if(t.length===1){start.x=t[0].clientX;start.y=t[0].clientY;} else if(t.length>=2){start.d=dist(t[0],t[1]);start.a=ang(t[0],t[1]);}}, {passive:false});
addEventListener('touchmove',e=>{e.preventDefault();const t=ts(e); if(t.length===1){const dx=(t[0].clientX-start.x)*mapPX, dy=(t[0].clientY-start.y)*mapPX; group.setAttribute('position',{x:base.pos.x+dx,y:base.pos.y-dy,z:-2});} else if(t.length>=2){const d=dist(t[0],t[1]), a=ang(t[0],t[1]); const sc=Math.max(0.2,Math.min(6, base.scale*(d/Math.max(1,start.d)))); const rz=base.rotZ+(a-start.a)*(180/Math.PI); group.setAttribute('scale',{x:sc,y:sc,z:sc}); group.setAttribute('rotation',{x:0,y:0,z:rz});}}, {passive:false});
addEventListener('touchend',e=>{e.preventDefault(); if(e.touches.length===0) setFromGroup();},{passive:false});

/* ---- Resilience ---- */
document.addEventListener('visibilitychange',()=>{ if(!document.hidden) sponsorVid.play().catch(()=>{}); });
</script>
</body>
</html>
